Bootstrap: docker
From: arm64v8/ubuntu:22.04

%post
    # Update and install system dependencies
    export DEBIAN_FRONTEND=noninteractive
    apt-get update && apt-get install -y \
        python3 python3-pip python3-dev python3-venv \
        build-essential \
        libhdf5-dev \
        libhdf5-serial-dev \
        hdf5-tools \
        pkg-config \
        libatlas-base-dev \
        libblas-dev \
        liblapack-dev \
        gfortran \
        git \
        curl \
        wget \
        && rm -rf /var/lib/apt/lists/*

    # Create a virtual environment to avoid conflicts
    python3 -m venv /opt/venv
    . /opt/venv/bin/activate

    # Upgrade pip and install wheel first
    pip install --no-cache-dir --upgrade pip setuptools wheel

    # Set environment variables for ARM64 optimization
    export OPENBLAS_NUM_THREADS=1
    export HDF5_DIR=/usr/lib/aarch64-linux-gnu/hdf5/serial

    # Install packages in order of dependency complexity
    # Start with numpy using pre-compiled wheels
    pip install --no-cache-dir numpy

    # Install other scientific packages
    pip install --no-cache-dir \
        pandas \
        scikit-learn \
        h5py

    # Option 1: TensorFlow for ARM64 (recommended)
    pip install --no-cache-dir tensorflow-aarch64

    # Option 2: If tensorflow-aarch64 doesn't work, try regular tensorflow with specific version
    # pip install --no-cache-dir tensorflow==2.13.0

    # Option 3: Use conda-forge for better ARM64 support (uncomment if needed)
    # wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-aarch64.sh
    # bash Miniforge3-Linux-aarch64.sh -b -p /opt/conda
    # /opt/conda/bin/conda install -y tensorflow scikit-learn pandas numpy h5py

    # Clean up (avoid removing mounted directories)
    apt-get clean
    rm -rf /var/lib/apt/lists/*
    # Note: Don't clean /tmp/* and /var/tmp/* during build as they may contain mounted filesystems

%environment
    export PATH="/opt/venv/bin:$PATH"
    export OPENBLAS_NUM_THREADS=1

%runscript
    exec "$@"
